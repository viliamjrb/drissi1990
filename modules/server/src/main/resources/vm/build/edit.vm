<!DOCTYPE html>
<html>

<head>
    #parse("./common/head.vm")
    <title>项目管理系统</title>
    <style>
        body {
            padding: 10px;
        }
    </style>
</head>

<body>
<div class="layui-container">
    <form action="./updateBuild" class="layui-form" id="form_build" lay-filter="form_build">
        <input name="id" type="hidden" value="$!model.id">
        <div class="layui-form-item">
            <label class="layui-form-label">名称</label>
            <div class="layui-input-block">
                <input type="text" name="name" required lay-verify="required" value="$!model.name" placeholder="请输入构建名称"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">仓库地址</label>
            <div class="layui-input-block">
                <input type="text" name="gitUrl" required lay-verify="required"
                       value="$!model.gitUrl"
                       placeholder="请输入构建名称"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">登录名</label>
            <div class="layui-input-block">
                <input type="text" name="userName" required lay-verify="required" value="$!model.userName"
                       placeholder="请输入登录名"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="password" required lay-verify="required"
                       value="$!model.password"
                       placeholder="请输入密码"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">分支</label>
            <div class="layui-input-block">
                <select name="branchName" id="branchName" lay-verify="required" lay-filter="branchName"
                        lay-search="">
                    <option value="">请先填写url、账号信息</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">构建命令</label>
            <div class="layui-input-block">
                    <textarea name="script"
                              placeholder="构建命令执行的命令，如：mvn clean package"
                              class="layui-textarea">$!model.script</textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">产物目录</label>
            <div class="layui-input-block">
                <input type="text" name="resultDirFile" required lay-verify="required"
                       value="$!model.resultDirFile"
                       placeholder="构建产物目录"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">发布操作</label>
            <div class="layui-input-block">
                #foreach($item in $releaseMethods)
                    <input type="radio" name="releaseMethod" lay-filter="releaseMethod" value="$item.code"
                           title="$item.desc"  #if($model.releaseMethod==$item.code)
                           checked
                    #end>
                #end
            </div>
        </div>
        <div id="releaseMethodDiv1" #if($model.releaseMethod!=1)style="display: none;"#end>
            <div class="layui-form-item">
                <label class="layui-form-label">分发项目</label>
                <div class="layui-input-block">
                    <select name="releaseMethodDataId_1" lay-filter="releaseMethodDataId_1">
                        <option value="">请选择分发项目</option>
                        #foreach($item in $outGivingModels)
                            <option value="$item.id"
                                #if($model.releaseMethodDataId==$item.id)
                                    selected
                                    #set($cOutAfterOpt=$item.afterOpt)
                                #end
                                    afterOpt="$!item.afterOpt">$item.name</option>
                        #end
                    </select>
                </div>
            </div>
            <div class="layui-form-item" id="releaseMethodDataId_1_after">
                <label class="layui-form-label">分发后</label>
                <div class="layui-input-block">
                    <input type="text" disabled readonly
                           value="#if($cOutAfterOpt)#foreach($coItem in $outAfterOpt)#if($cOutAfterOpt==$coItem.code)$coItem.desc#end#end#end"
                           class="layui-input">

                </div>
            </div>
        </div>

        <div class="layui-form-item" id="releaseMethodDiv2" #if($model.releaseMethod!=2)style="display: none;"#end>
            <div class="layui-inline">
                <label class="layui-form-label">节点</label>
                <div class="layui-input-block">
                    <select name="releaseMethodDataId_2_node" lay-filter="releaseMethodDataId_2">
                        <option value="">请选择节点</option>
                        #foreach($i in $nodeModels)
                            <option value="$i.id">$i.name</option>
                        #end
                    </select>
                </div>
            </div>
            <div class="layui-inline" id="releaseMethodDiv2_Project">
            </div>
        </div>
        <div class="layui-form-item" id="afterOptDiv" #if($model.releaseMethod!=2)
             style="display: none;" #end>
            <label class="layui-form-label">发布后</label>
            <div class="layui-input-block">
                <select name="afterOpt" id="afterOpt">
                    <option value="">请选择发布后的操作</option>
                    #foreach($item in $afterOpt)
                        <option value="$item.code"
                                #if($item.code==$model.afterOpt)selected #end>$item.desc</option>
                    #end
                </select>
            </div>
        </div>
    ##提交按钮
        <div class="layui-form-item">
            <div class="layui-form-item" style="padding-left: 20%;margin-top: 20px;">
                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitBuild" id="submitBuild">
                    提交
                </button>
            </div>
        </div>
    </form>
</div>
</body>
    #foreach($i in $nodeModels)
    <script type="text/html" id="node_project_$i.id">
        <label class="layui-form-label">项目</label>
        <div class="layui-input-block">
            <select name="releaseMethodDataId_2_project">
                <option value="">选择选择项目</option>
                #foreach($ii in $i.groupProjects)
                    <optgroup label="$ii.group">
                        #foreach($iProject in $ii.projects)
                            <option value="$iProject.id">$iProject.name</option>
                        #end
                    </optgroup>
                #end
            </select>
        </div>
    </script>
    #end
<script type="text/javascript">
    function getBranchList(fn) {
        loadingAjax({
            url: './branchList.json',
            data: {
                url: $("input[name='gitUrl']").val(),
                userName: $("input[name='userName']").val(),
                userPwd: $("input[name='password']").val()
            },
            success: function (data) {
                if (data.code != 200) {
                    layer.msg(data.msg);
                } else {
                    var selectGroup = $("select[name='branchName']");
                    for (var i = 0; i < data.data.length; i++) {
                        var text = data.data[i];
                        var ext = $("select[name='branchName'] option[value='" + text + "']");
                        if (ext.length <= 0) {
                            selectGroup.find("option").last().after("<option value='" + text + "'>" + text + "</option>");
                        }
                    }
                    fn && fn();
                    form.render('select');
                }
            }
        });
    }

    function loadSuccess() {
        $("input[name='password'],input[name='userName'],input[name='gitUrl']").change(function () {
            getBranchList();
        });
        #if($model)
            getBranchList(function () {
                form.val("form_build", {
                    "branchName": "$!model.branchName"
                })
            });
        #end
        // 提交信息
        form.on('submit(submitBuild)', function (data) {
            var sendData = data.field;
            if (!sendData.branchName) {
                layer.msg("请选择分支");
                return false;
            }
            loadingAjax({
                url: data.form.action,
                data: sendData,
                success: function (data) {
                    layer.msg(data.msg);
                    if (200 == data.code) {
                        setTimeout(function () {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            parent.location.reload();
                        }, 1500);
                    }
                }
            });
            return false;
        });

        form.on('radio(releaseMethod)', function (data) {
            $("#releaseMethodDiv1").hide();
            $("#releaseMethodDiv2").hide();
            $("#afterOptDiv").hide();
            if (data.value == 1) {
                $("#releaseMethodDiv1").show();
                // $("#afterOptDiv").show();
            } else if (data.value == 2) {
                // 项目
                $("#releaseMethodDiv2").show();
                $("#afterOptDiv").show();
            }
        });
        var outAfterOpt = [];
        #if($outAfterOpt)
            outAfterOpt = $outAfterOpt;
        #end
        form.on('select(releaseMethodDataId_1)', function (data) {
            if (data.value == "" || !data.value) {
                $("#releaseMethodDataId_1_after").hide();
                return;
            }
            var afterOpt = $(data.elem).find("option[value='" + data.value + "']").attr("afterOpt");
            $("#releaseMethodDataId_1_after").show();
            for (var i = 0; i < outAfterOpt.length; i++) {
                if (outAfterOpt[i].code == afterOpt) {
                    $("#releaseMethodDataId_1_after").find("input").val(outAfterOpt[i].desc);
                    break;
                }
            }
        });

        layui.use(['laytpl'], function () {
            var laytpl = layui.laytpl;
            form.on('select(releaseMethodDataId_2)', function (data) {
                if (!data.value || data.value == "") {
                    $("#releaseMethodDiv2_Project").hide();
                    return;
                }
                changeProject(data.value);
            });
            #if($model.releaseMethodDataId)
                var releaseMethodDataId = "$model.releaseMethodDataId";
                var ids = releaseMethodDataId.split(":");
                changeProject(ids[0], ids[1]);
            #end

            function changeProject(nodeId, pid) {
                var html = document.getElementById('node_project_' + nodeId);
                laytpl(html.innerHTML).render({}, function (newHtml) {
                    $("#releaseMethodDiv2_Project").html(newHtml);
                    if (pid) {
                        $("select[name='releaseMethodDataId_2_project']").val(pid);
                        $("select[name='releaseMethodDataId_2_node']").val(nodeId);
                    }
                    form.render();
                });
            }
        });

    }
</script>
</html>
