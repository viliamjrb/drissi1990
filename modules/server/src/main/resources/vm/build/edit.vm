<!DOCTYPE html>
<html>

<head>
    #parse("./common/head.vm")
    <title>项目管理系统</title>
    <style>
        body {
            padding: 10px;
        }
    </style>
</head>

<body>
<div class="layui-container">
    <form action="./updateBuild" class="layui-form" id="form_build" lay-filter="form_build">
        <input name="id" type="hidden" value="$!model.id">
        <div class="layui-form-item">
            <label class="layui-form-label">名称</label>
            <div class="layui-input-block">
                <input type="text" name="name" required lay-verify="required" value="$!model.name" placeholder="请输入构建名称"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">仓库地址</label>
            <div class="layui-input-block">
                <input type="text" name="gitUrl" required lay-verify="required"
                       value="$!model.gitUrl"
                       placeholder="请输入构建名称"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">登录名</label>
            <div class="layui-input-block">
                <input type="text" name="userName" required lay-verify="required" value="$!model.userName"
                       placeholder="请输入登录名"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="password" required lay-verify="required"
                       value="$!model.password"
                       placeholder="请输入密码"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">分支</label>
            <div class="layui-input-block">
                <select name="branchName" id="branchName" lay-verify="required" lay-filter="branchName"
                        lay-search="">
                    <option value="">请先填写url、账号信息</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">产物目录</label>
            <div class="layui-input-block">
                <input type="text" name="resultDirFile" required lay-verify="required"
                       value="$!model.resultDirFile"
                       placeholder="构建产物目录"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">构建命令</label>
            <div class="layui-input-block">
                    <textarea name="script"
                              placeholder="构建命令执行的命令，如：mvn clean package"
                              class="layui-textarea">$!model.script</textarea>
            </div>
        </div>
    ##提交按钮
        <div class="layui-form-item">
            <div class="layui-form-item" style="padding-left: 20%;margin-top: 20px;">
                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitBuild" id="submitBuild">
                    提交
                </button>
            </div>
        </div>
    </form>
</div>
</body>
<script type="text/javascript">
    function getBranchList(fn) {
        loadingAjax({
            url: './branchList.json',
            data: {
                url: $("input[name='gitUrl']").val(),
                userName: $("input[name='userName']").val(),
                userPwd: $("input[name='password']").val()
            },
            success: function (data) {
                if (data.code != 200) {
                    layer.msg(data.msg);
                } else {
                    var selectGroup = $("select[name='branchName']");
                    for (var i = 0; i < data.data.length; i++) {
                        var text = data.data[i];
                        var ext = $("select[name='branchName'] option[value='" + text + "']");
                        if (ext.length <= 0) {
                            selectGroup.find("option").last().after("<option value='" + text + "'>" + text + "</option>");
                        }
                    }
                    fn && fn();
                    form.render('select');
                }
            }
        });
    }

    function loadSuccess() {
        $("input[name='password'],input[name='userName'],input[name='gitUrl']").change(function () {
            getBranchList();
        });
        #if($model)
            getBranchList(function () {
                form.val("form_build", {
                    "branchName": "$!model.branchName"
                })
            });
        #end
        // 提交信息
        form.on('submit(submitBuild)', function (data) {
            var sendData = data.field;
            if (!sendData.branchName) {
                layer.msg("请选择分支");
                return false;
            }
            loadingAjax({
                url: data.form.action,
                data: sendData,
                success: function (data) {
                    layer.msg(data.msg);
                    if (200 == data.code) {
                        setTimeout(function () {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            parent.location.reload();
                        }, 1500);
                    }
                }
            });
            return false;
        });
    }
</script>
</html>
