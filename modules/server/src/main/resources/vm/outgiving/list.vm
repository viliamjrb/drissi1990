<!DOCTYPE html>
<html>

<head>
    #parse("./common/head.vm")
    <title>项目管理系统</title>
    <style>
        body {
            padding: 10px;
        }
    </style>
</head>
<body>
    #if($user.isServerManager())
    <div class="layui-row">
        <button onclick="editProject('');" class="layui-btn layui-btn-sm">创建关联项目</button>
    </div>
    #end
    #if($array && $array.size()>0)

    <div class="layui-collapse" style="margin: 10px;">
        #foreach($item in $array)
            <div class="layui-colla-item">
                <div class="layui-colla-title">
                    <div title="$item.id">
                        $item.name
                    </div>
                    <div class="layui-layout-right" style="padding-right: 10%;">
                        #if($user.isServerManager())
                            <button op="add" id="$item.id" class="layui-btn layui-btn-sm layui-btn-warm">
                                <i class="layui-icon">&#xe609;</i>
                                分发文件
                            </button>
                            <button op="edit" id="$item.id" class="layui-btn layui-btn-sm ">
                                <i class="layui-icon">&#xe642;</i>
                                编辑
                            </button>
                        #end
                    </div>
                </div>
                <div class="layui-colla-content layui-show">
                    <form class="layui-form" action="">
                        <table class="layui-table" id="table_$item.id">
                            <thead>
                            <tr>
                                <th>节点名称</th>
                                <th>项目名称</th>
                                <th>项目状态</th>
                                <th>分发状态</th>
                                <th>最后分发时间</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="tbody_$item.id">
                                #foreach($tr in $item.nodeProjectList)
                                    #if($nodeData[$tr.nodeId])
                                    <tr>
                                        <td>
                                            <div title="$tr.nodeId">$nodeData[$tr.nodeId].name</div>
                                        </td>
                                        <td>
                                            <div title="$tr.projectId">$nodeData[$tr.nodeId].projects[$tr.projectId].name</div>
                                        </td>
                                        <td>
                                            <div title="请到控制台中管理项目">
                                                <input type="checkbox" id="status_$!tr.nodeId$!tr.projectId" disabled
                                                       name="status"
                                                       lay-skin="switch"
                                                       lay-text="运行中|未运行">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="viewMsg"
                                                 #if($tr.status!=2)style="color: red;font-weight: bold;"#end
                                                 msgId="msg_$!tr.nodeId$tr.projectId">$tr.statusMsg</div>
                                        </td>
                                        <td>
                                            $tr.lastOutGivingTime
                                        </td>
                                        <td>
                                            #if($user.isServerManager())
                                                <button op="conslone" nodeId="$tr.nodeId" projectId="$tr.projectId"
                                                        class="layui-btn layui-btn-sm layui-btn-normal">
                                                    控制台
                                                </button>
                                                <button op="file" nodeId="$tr.nodeId" projectId="$tr.projectId"
                                                        class="layui-btn layui-btn-sm">
                                                    文件管理
                                                </button>
                                            #else
                                                没有权限
                                            #end
                                        </td>
                                    </tr>
                                    #else
                                    <tr>
                                        <td colspan="6" align="center">
                                            $tr.nodeId 节点不可用或者已经暂停
                                        </td>
                                    </tr>
                                    #end
                                <script type="text/html" id="msg_$!tr.nodeId$tr.projectId">$!tr.result</script>
                                <script type="text/javascript">
                                    //
                                    asyncFn.push(function () {
                                        silentAjax({
                                            url: "./getProjectStatus",
                                            data: {
                                                nodeId: "$tr.nodeId",
                                                id: "$tr.projectId"
                                            },
                                            success: function (data) {
                                                if (200 == data.code) {
                                                    var pId = data.data.pId;
                                                    if (pId > 0) {
                                                        $("#status_$!tr.nodeId$!tr.projectId")
                                                                .attr("checked", true)
                                                                .parent().attr("title", "运行中：" + pId);
                                                        form.render();
                                                    }
                                                }
                                            }
                                        });
                                    });
                                </script>
                                #end
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>
        #end
    </div>

    #else
    <h1 align="center">还没有任何分发项目，请先创建分发项目</h1>
    #end
</body>
<script type="text/javascript">

    function loadSuccess() {
        // 点击事件
        $("button[op]").click(function (e) {
            layui.stope(e);
            var op = $(this).attr("op");
            if ("conslone" == op || "file" == op) {
                var nodeId = $(this).attr("nodeId");
                var projectId = $(this).attr("projectId");
                var parName = "file" == op ? "toFile" : "toConsole";
                //
                var url = "/node/index.html";
                url = urlUpdateParams(url, "nodeId", nodeId);
                url = urlUpdateParams(url, parName, projectId);
                var win = top.window.open(url, nodeId + projectId);
                win.focus();
                return;
            }
            if ("edit" == op) {
                editProject($(this).attr("id"));
                return;
            }
            if ("add" == op) {
                var id = $(this).attr("id");
                layer.open({
                    type: 2,
                    title: '添加分发文件',
                    shade: 0.8,
                    area: ['40%', '60%'],
                    content: 'addOutgiving.html?id=' + id
                });
                return;
            }
        });

        //
        $("div[class='viewMsg']").click(function () {
            var msgId = $(this).attr("msgId");
            var html = document.getElementById(msgId).innerHTML;
            if (!html || html == "") {
                return;
            }
            layer.alert(html);
        });
    }

    function editProject(id) {
        layer.open({
            type: 2,
            title: '管理分发信息',
            shade: 0.8,
            area: ['80%', '80%'],
            content: 'edit.html?id=' + id
        });
    }
</script>
</html>