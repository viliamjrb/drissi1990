<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head th:replace="common/head::head">
</head>

<body>
<div class="layui-container">
    <form th:action="${userItem!=null}?'./updateUser':'./addUser'" class="layui-form" id="form_user">
        <div class="layui-form-item">

            <label class="layui-form-label">登录名</label>
            <div class="layui-input-block" th:title="${userItem!=null}?'不能修改登录名':''">
                <input type="text" name="id" placeholder="登录名,创建后不能修改" required lay-verify="required"
                       class="layui-input" th:value="${userItem?.id}" th:readonly="${userItem}">
                <input name="reqId" type="hidden" th:value="${reqId}">
            </div>
        </div>
        <div class="layui-form-item" id="pwd-input-div">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="password" th:placeholder="${userItem==null}?'请输入登录密码':'如果不修改则不用填写'"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">昵称</label>
            <div class="layui-input-block">
                <input type="text" name="name" placeholder="昵称" th:value="${userItem?.name}" required
                       lay-verify="required" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">服务管理员</label>
                <div class="layui-input-block">
                    <input type="checkbox" value="true"
                           th:checked="${userItem?.serverManager}"
                           name="serverManager"
                           lay-skin="switch"
                           lay-text="是|否">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">授权节点</label>
            <div class="layui-input-block">

                <div class="layui-collapse">

                    <div class="layui-colla-item" th:each="item : ${nodeModels}">
                        <div class="layui-colla-title">
                            <div th:title="${item.id}" th:text="${item.name}">
                            </div>
                            <div class="layui-layout-right" onclick="stope()" style="padding-right: 10%;">
                                <div class="layui-inline">
                                    <label class="layui-form-label" style="margin-top: 8px;">节点管理员</label>
                                    <div class="layui-input-block">
                                        <input type="checkbox" value="true" th:nodeId="${item.id}"
                                               th:checked="${userItem?.nodeRole[item.id]?.manage}"
                                               th:name="${item.id}+'_manage'" lay-filter="manage" lay-skin="switch"
                                               lay-text="是|否">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-colla-content layui-show">
                            <div class="layui-form-item" th:id="'projectsDiv_'+${item.id}">
                                <label class="layui-form-label" title="能删除项目，启动停止项目">管理项目</label>
                                <div class="layui-inline">
                                    <div th:id="'projectOpt_'+${item.id}" style="display: none;">
                                        <div class="layui-inline">
                                            <label class="layui-form-label">上传文件</label>
                                            <div class="layui-input-block">
                                                <input type="checkbox" value="true"
                                                       th:checked="${userItem?.nodeRole[item.id]?.uploadFile}"
                                                       th:name="${item.id}+'_uploadFile'" lay-skin="switch"
                                                       lay-text="是|否">
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label">删除文件</label>
                                            <div class="layui-input-block">
                                                <input type="checkbox" value="true"
                                                       th:checked="${userItem?.nodeRole[item.id]?.deleteFile}"
                                                       th:name="${item.id}+'_deleteFile'" lay-skin="switch"
                                                       lay-text="是|否">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div th:id="'tree_'+${item.id}"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="layui-form-item" th:unless="${#lists.isEmpty(nodeTomcat[item.id])}">
                                <label class="layui-form-label">管理Tomcat</label>
                                <div class="layui-inline">
                                    <div th:id="'tomcatOpt_'+${item.id}">
                                        <div class="layui-inline">
                                            <label class="layui-form-label">上传文件</label>
                                            <div class="layui-input-block">
                                                <input type="checkbox" value="true"
                                                       th:checked="${userItem?.nodeTomcatRole[item.id]?.uploadFile}"
                                                       th:name="${item.id}+'_uploadTomcatFile'" lay-skin="switch"
                                                       lay-text="是|否">
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label">删除文件</label>
                                            <div class="layui-input-block">
                                                <input type="checkbox" value="true"
                                                       th:checked="${userItem?.nodeTomcatRole[item.id]?.deleteFile}"
                                                       th:name="${item.id}+'_deleteTomcatFile'" lay-skin="switch"
                                                       lay-text="是|否">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <input th:each="pItem : ${nodeTomcat[item.id]}" type="checkbox"
                                               lay-filter="manageTomcat"
                                               th:p="'p_'+${item.id}"
                                               th:name="'p_'+${item.id}+'_'+${pItem.id}"
                                               th:checked="${userItem?.isTomcat(item.id,pItem.id)}"
                                               th:project="${pItem.id}"
                                               th:value="${pItem.id}"
                                               th:node_id="${item.id}"
                                               th:title="${pItem.name}">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="layui-colla-item" th:if="${#lists.isEmpty(nodeModels)}">
                        <div class="layui-colla-title">
                            没有可用节点
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="layui-form-item" style="padding-left: 20%;margin-top: 20px;">
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitUser" id="submitUser">提交
            </button>
        </div>
    </form>
</div>
</body>
<div th:replace="common/sha1::sha1"></div>
<script type="text/javascript" th:inline="javascript">
    function stope(e) {
        layui.stope(e);
    }

    var nodeModels = [[${nodeModels}]];

    function loadSuccess() {
        var treeNodes = [];
        layui.use(['tree'], function () {
            tree = layui.tree;
            loadNode();

            //加载树
            function loadNode() {

                if (nodeModels && nodeModels.length > 0) {
                    for (var j = 0; j < nodeModels.length; j++) {
                        var nodeModel = nodeModels[j];
                        var groupProjects = nodeModel.groupProjects;
                        if (groupProjects && groupProjects.length > 0) {
                            formateProjects(groupProjects, nodeModel.id);
                        } else {
                            //没有项目
                            var divId = "#projectsDiv_" + nodeModel.id;
                            $(divId).css("display", "none");
                        }
                    }
                    //渲染选中节点
                    loadProjects();
                }
            }

            //将节点项目数据转换为tree格式
            function formateProjects(data, nodeId) {
                if (!data || data.length <= 0) {
                    return;
                }
                for (var i = 0; i < data.length; i++) {
                    //分组
                    var group = data[i];
                    group.title = group.group;
                    var projects = group.projects;
                    group.spread = true;
                    group.nodeId = nodeId;
                    group.id = nodeId;
                    group.children = projects;
                    if (projects && projects.length > 0) {
                        //项目
                        for (var j = 0; j < projects.length; j++) {
                            var project = projects[j];
                            project.title = project.name;
                            project.nodeId = nodeId;
                        }
                    }
                }
                //渲染树
                loadTree(data, nodeId);
                tomcatManage(nodeId, false);
            }

            //渲染树
            function loadTree(data, nodeId) {
                tree.render({
                    elem: '#tree_' + nodeId,
                    data: data,
                    id: nodeId,
                    showCheckbox: true,
                    oncheck: function (obj) {
                        var nodeData = obj.data;
                        var nId = nodeData.nodeId;
                        //获得选中的节点
                        var checkData = tree.getChecked(nId);
                        var projectId = "#projectOpt_" + nodeId;
                        if (checkData && checkData.length > 0) {
                            $(projectId).css("display", "block");
                        } else {
                            $(projectId).css("display", "none");
                            var uploadId = $('input[name=' + nodeId + '_uploadFile]');
                            var deleteId = $('input[name=' + nodeId + '_deleteFile]');
                            uploadId.prop('checked', false);
                            deleteId.prop('checked', false);
                            form.render();
                        }
                    }
                });
            }

            //渲染选中节点
            function loadProjects() {
                var userItem = [[${userItem}]];
                if (!userItem) {
                    return;
                }
                var nodeRole = userItem.nodeRole;
                for (var key in nodeRole) {
                    var item = nodeRole[key];
                    var projects = item.projects;
                    if (!projects || projects.length <= 0) {
                        continue;
                    }
                    //批量勾选
                    tree.setChecked(key, projects);
                }
            }

            //监听tomcat选择
            form.on('checkbox(manageTomcat)', function (data) {
                var check = data.elem.checked;
                var dom = data.elem;
                var nodeId = dom.getAttribute("node_id");
                tomcatManage(nodeId, check);
            });

            //更新tomcat管理
            function tomcatManage(nodeId, check) {
                if (!nodeId) {
                    return;
                }
                var id = "#tomcatOpt_" + nodeId;
                if (check) {
                    $(id).css("display", "block");
                } else {
                    var list = $("input[node_id=" + nodeId + "]:checked");
                    if (!list || list.length <= 0) {
                        $(id).css("display", "none");
                        var uploadId = $('input[name=' + nodeId + '_uploadTomcatFile]');
                        var deleteId = $('input[name=' + nodeId + '_deleteTomcatFile]');
                        uploadId.prop('checked', false);
                        deleteId.prop('checked', false);
                        form.render();
                    }
                }
            }

            // 提交用户信息
            form.on('submit(submitUser)', function (data) {
                var sendData = formatPwd(data.field, "password");
                sendData = getCheckProject(sendData);
                loadingAjax({
                    url: data.form.action,
                    data: sendData,
                    success: function (data) {
                        layer.msg(data.msg);
                        if (200 == data.code) {
                            setTimeout(function () {
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                                parent.location.reload();
                            }, 1500);
                        }
                    }
                });
                return false;
            });

            //勾选的项目 排除目录
            function getCheckProject(data) {
                var projects = {};
                for (var i = 0; i < nodeModels.length; i++) {
                    var node = nodeModels[i];
                    var nodeId = node.id;
                    var projectArray = [];
                    var checkData = tree.getChecked(nodeId);
                    if (!checkData || checkData.length <= 0) {
                        continue;
                    }
                    for (var j = 0; j < checkData.length; j++) {
                        var children = checkData[j].children;
                        if (!children || children.length <= 0) {
                            continue;
                        }
                        for (var k = 0; k < children.length; k++) {
                            var projectId = children[k].id;
                            projectArray.push(projectId);
                        }
                    }
                    projects[nodeId] = projectArray;
                }
                data.projects = JSON.stringify(projects);
                return data;
            }
        });
    }
</script>
</html>
