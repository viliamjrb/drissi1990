<!DOCTYPE html>
<html>

<head>
    #parse("./common/head.vm")
    <link href="$!jpomProxyPath/static/ztree/zTreeStyle/zTreeStyle.css" rel="stylesheet">
    <title>项目管理系统</title>
    <style>


        body {
            padding: 10px;
        }

        .div-layui-form-switch {
            margin-top: 0px !important;
        }

    </style>
</head>

<body>
<div class="layui-container">
    <form action="#if($userItem)./updateUser#else./addUser#end" class="layui-form" id="form_user">
        <div class="layui-form-item">

            <label class="layui-form-label">登录名</label>
            <div class="layui-input-block" #if($userItem) title="不能修改登录名"#end>
                <input type="text" name="id" placeholder="登录名,创建后不能修改" required lay-verify="required"
                       class="layui-input" value="$!userItem.id" #if($userItem)readonly#end>
                <input name="reqId" type="hidden" value="$reqId">
            </div>
        </div>
        <div class="layui-form-item" id="pwd-input-div">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="password" placeholder="#if(!$userItem)请输入登录密码#else 如果不修改则不用填写#end"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">昵称</label>
            <div class="layui-input-block">
                <input type="text" name="name" placeholder="昵称" value="$!userItem.name" required
                       lay-verify="required" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">服务管理员</label>
                <div class="layui-input-block">
                    <input type="checkbox" value="true"
                        #if($userItem.serverManager)
                           checked
                        #end
                           name="serverManager"
                           lay-skin="switch"
                           lay-text="是|否">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">授权节点</label>
            <div class="layui-input-block">

                <div class="layui-collapse">
                    #if($nodeModels && $nodeModels.size()>0)
                        #foreach($item in $nodeModels)
                        <div class="layui-colla-item">
                            <div class="layui-colla-title">
                                <div title="$item.id">
                                    $item.name
                                </div>
                                <div class="layui-layout-right" onclick="stope()" style="padding-right: 10%;">
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="margin-top: 8px;">节点管理员</label>
                                        <div class="layui-input-block">
                                            #set($nowName=$item.id+"_manage")
                                            <input type="checkbox" value="true" nodeId="$item.id"
                                                #if($userItem.nodeRole[$item.id].manage)
                                                   checked
                                                #end
                                                   name="$nowName" lay-filter="manage" lay-skin="switch"
                                                   lay-text="是|否">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-colla-content layui-show">
                                <div class="layui-form-item" id="projectsDiv">
                                    <label class="layui-form-label" title="能删除项目，启动停止项目">管理项目</label>
                                    <div class="layui-inline">
                                        <div id="projectOpt_$!item.id" style="display: none;">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">上传文件</label>
                                                <div class="layui-input-block">
                                                    #set($nowName=$item.id+"_uploadFile")
                                                    <input type="checkbox" value="true"
                                                        #if($userItem.nodeRole[$item.id].uploadFile)
                                                           checked
                                                        #end
                                                           name="$nowName" lay-skin="switch" lay-text="是|否">
                                                </div>
                                            </div>
                                            <div class="layui-inline">
                                                <label class="layui-form-label">删除文件</label>
                                                <div class="layui-input-block">
                                                    #set($nowName=$item.id+"_deleteFile")
                                                    <input type="checkbox" value="true"
                                                        #if($userItem.nodeRole[$item.id].deleteFile)
                                                           checked
                                                        #end
                                                           name="$nowName" lay-skin="switch" lay-text="是|否">
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <ul id="tree_$item.id" class="ztree"></ul>
                                        </div>
                                    </div>
                                </div>
                                #if($nodeTomcat)
                                    #set($nowTomcat=$nodeTomcat[$item.id])
                                #end
                                #if($nowTomcat&&$nowTomcat.size()>0)
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">管理Tomcat</label>
                                        <div class="layui-inline">
                                            <div id="tomcatOpt_$item.id">
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">上传文件</label>
                                                    <div class="layui-input-block">
                                                        #set($nowName=$item.id+"_uploadTomcatFile")
                                                        <input type="checkbox" value="true"
                                                            #if($userItem.nodeTomcatRole[$item.id].uploadFile)
                                                               checked
                                                            #end
                                                               name="$nowName" lay-skin="switch" lay-text="是|否">
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">删除文件</label>
                                                    <div class="layui-input-block">
                                                        #set($nowName=$item.id+"_deleteTomcatFile")
                                                        <input type="checkbox" value="true"
                                                            #if($userItem.nodeTomcatRole[$item.id].deleteFile)
                                                               checked
                                                            #end
                                                               name="$nowName" lay-skin="switch" lay-text="是|否">
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                #foreach($pItem in $nowTomcat)
                                                    #set($nowName="p_"+$item.id+"_"+$pItem.id)
                                                    <input type="checkbox" lay-filter="manageTomcat"
                                                           p="p_$item.id"
                                                           name="$nowName"
                                                           #if($userItem.isTomcat($item.id,$pItem.id))checked#end
                                                           project="$pItem.id"
                                                           value="$pItem.id"
                                                           node_id="$item.id"
                                                           title="$pItem.name">
                                                #end
                                            </div>
                                        </div>
                                    </div>
                                #end
                            </div>
                        #end
                    #else
                        #set($errorNode=true)
                        <div class="layui-colla-item">
                            <div class="layui-colla-title">
                                没有可用节点
                            </div>
                        </div>
                    #end
                </div>
                </div>
            </div>
            #if(!$errorNode)
                <div class="layui-form-item" style="padding-left: 20%;margin-top: 20px;">
                    <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitUser" id="submitUser">提交
                    </button>
                </div>
            #end
    </form>
</div>
</body>
    #parse("./common/sha1.vm")
<script type="text/javascript">
    function stope(e) {
        layui.stope(e);
    }

    function evil(fn) {
        var Fn = Function;
        return new Fn('return ' + fn)();
    }

    function loadSuccess() {
        var treeNodes = [];

        // 提交用户信息
        form.on('submit(submitUser)', function (data) {
            var sendData = formatPwd(data.field, "password");
            sendData = getCheckProject(sendData);
            loadingAjax({
                url: data.form.action,
                data: sendData,
                success: function (data) {
                    layer.msg(data.msg);
                    if (200 == data.code) {
                        setTimeout(function () {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            parent.location.reload();
                        }, 1500);
                    }
                }
            });
            return false;
        });

        //勾选的项目 排除目录
        function getCheckProject(data) {
            if (!treeNodes || treeNodes.length <= 0) {
                return data;
            }
            var projects = {};
            for (var i = 0; i < treeNodes.length; i++) {
                var treeNode = treeNodes[i];
                var setting = treeNode.setting;
                var nodeId = setting.nodeId;
                var nodes = treeNode.getCheckedNodes(true);
                if (!nodes || nodes.length <= 0) {
                    continue;
                }
                var group = treeNode.group;
                var nodeProjects = [];
                for (var j = 0; j < nodes.length; j++) {
                    var node = nodes[j];
                    var id = node.id;
                    if (id) {
                        nodeProjects.push(id);
                    }
                }
                projects[nodeId] = nodeProjects;
            }
            data.projects = JSON.stringify(projects);
            return data;
        }

        asyncLoadJs("$!jpomProxyPath/static/ztree/jquery.ztree.core.min.js", function () {
            asyncLoadJs("$!jpomProxyPath/static/ztree/jquery.ztree.excheck.min.js", function () {
                var nodeModels = '$nodeModels';
                if (typeof nodeModels == "string") {
                    nodeModels = evil(nodeModels);
                }
                if (nodeModels && nodeModels.length > 0) {
                    var setting = {
                        check: {
                            enable: true,
                            chkStyle: "checkbox",
                            chkboxType: {
                                "Y": "ps",
                                "N": "ps"
                            },
                            autoCheckTrigger: true
                        },
                        data: {
                            simpleData: {
                                enable: true
                            },
                            key: {
                                name: "name",
                                children: "projects"
                            },
                            view: {
                                selectedMulti: false
                            }
                        },
                        callback: {
                            onCheck: zTreeOnCheck
                        }
                    };
                    for (var j = 0; j < nodeModels.length; j++) {
                        var nodeModel = nodeModels[j];
                        var groupProjects = nodeModel.groupProjects;
                        if (groupProjects && groupProjects.length > 0) {
                            for (var i = 0; i < groupProjects.length; i++) {
                                var project = groupProjects[i];
                                project.name = project.group;
                                project.nodeId = nodeModel.id
                            }
                        }
                        var id = "#tree_" + nodeModel.id;
                        setting.nodeId = nodeModel.id;
                        var zTreeObj = $.fn.zTree.init($(id), setting, groupProjects);
                        treeNodes.push(zTreeObj);
                        //展开节点
                        zTreeObj.expandAll(true);
                        tomcatManage(nodeModel.id, false);
                    }
                }
                loadProjects();
            });
        });

        //勾选回调
        function zTreeOnCheck(event, treeId, treeNode) {
            var check = treeNode.checked;
            var treeObj = $.fn.zTree.getZTreeObj(treeId);
            var setting = treeObj.setting;
            var nodeId = setting.nodeId;
            var id = "#projectOpt_" + nodeId;
            if (check) {
                $(id).css("display", "block");
            } else {
                var nodes = treeObj.getCheckedNodes(true);
                //全部取消勾选 隐藏开关并重置为未选中
                if (!nodes || nodes.length <= 0) {
                    $(id).css("display", "none");
                    var uploadId = $('input[name=' + nodeId + '_uploadFile]');
                    var deleteId = $('input[name=' + nodeId + '_deleteFile]');
                    uploadId.prop('checked', false);
                    deleteId.prop('checked', false);
                    form.render();
                }
            }
        }

        //渲染选中节点
        function loadProjects() {
            var userItem = '$!userItem';
            if (!userItem) {
                return false;
            }
            if (typeof userItem == "string") {
                userItem = evil(userItem);
            }
            var nodeRole = userItem.nodeRole;
            for (var key in nodeRole) {
                var item = nodeRole[key];
                var projects = item.projects;
                if (!projects || projects.length <= 0) {
                    continue;
                }
                var treeObj = $.fn.zTree.getZTreeObj("tree_" + key);
                if (!treeObj) {
                    continue;
                }
                for (var i = 0; i < projects.length; i++) {
                    var id = projects[i];
                    var obj = treeObj.getNodeByParam("id", id, null);
                    treeObj.checkNode(obj, true, true);
                }
            }
        }

        //监听tomcat选择
        form.on('checkbox(manageTomcat)', function (data) {
            var check = data.elem.checked;
            var dom = data.elem;
            var nodeId = dom.getAttribute("node_id");
            tomcatManage(nodeId, check);
        });

        //更新tomcat管理
        function tomcatManage(nodeId, check) {
            if (!nodeId) {
                return;
            }
            var id = "#tomcatOpt_" + nodeId;
            if (check) {
                $(id).css("display", "block");
            } else {
                var list = $("input[node_id=" + nodeId + "]:checked");
                if (!list || list.length <= 0) {
                    $(id).css("display", "none");
                    var uploadId = $('input[name=' + nodeId + '_uploadTomcatFile]');
                    var deleteId = $('input[name=' + nodeId + '_deleteTomcatFile]');
                    uploadId.prop('checked', false);
                    deleteId.prop('checked', false);
                    form.render();
                }
            }
        }
    }
</script>
</html>