<!DOCTYPE html>
<html>

<head>
    #parse("./common/head.vm")
    <title>nginx管理</title>
    <style>
        body {
            padding: 10px;
        }

        .context {
            height: 50vh;
        }
    </style>
</head>

<body>
<form action="" class="layui-form" id="fast_form">
    <input type="hidden" name="type" value="quick">
    <input type="hidden" name="genre" value="$type">
    <div class="layui-form-item">

        <label class="layui-form-label">文件路径</label>
        <div class="layui-input-inline">
            <select name="whitePath" id="whitePath" required lay-verify="required" #if($type=="update")disabled #end
                    class="selectBox">
                <option value="">请选择白名单路径</option>
                #foreach($item in $nginx)
                    <option value="$item" #if($item==$data.whitePath) selected #end>$item</option>
                #end
            </select>
        </div>
        <label class="layui-form-label">文件名称</label>
        <div class="layui-input-inline">
            <input type="text" name="name" placeholder='文件后缀必须为".conf"' class="layui-input"
                   value="$!data.name" required lay-verify="required" #if($type=="update")
                   disabled #end >
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">快速配置</label>
        <div class="layui-input-block auto">
            <div class="layui-collapse" style="margin-top:10px;">
                <div class="layui-colla-item">
                    <h2 class="layui-colla-title">监听设置</h2>
                    <div class="layui-colla-content layui-show" id="listen_context">
                        <div class="layui-form-item">
                            <label class="layui-form-label">SSL证书</label>
                            <div class="layui-input-block">
                                <select id="choose_cert" lay-filter="choose_cert"
                                        class="selectBox">
                                    <option value="">请选择证书</option>
                                    #foreach($item in $cert)
                                        <option value='$item.id' id="$item.domain" key="$item.key"
                                                cert="$item.cert"
                                                #if($item.cert==$data.cert)selected#end>$!item.id</option>
                                    #end
                                </select>
                            </div>
                        </div>
                        <div id="convert" #if($data.cert)#else class="div_hidden"#end style="display: none;">
                            <div class="layui-form-item ">
                                <label class="layui-form-label">跳转https</label>
                                <div class="layui-input-inline">
                                    <input lay-filter="convert" name="convert" type="checkbox"
                                        #if($data.convert) checked #end value="true" lay-text="开启|关闭"
                                           lay-skin="switch">
                                </div>
                            </div>
                            <div class="layui-form-item ">
                                <label class="layui-form-label">证书路径</label>
                                <div class="layui-input-block">
                                    <input type="text" name="cert" value="$!data.cert" id="cert" readonly
                                           class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">私钥路径</label>
                                <div class="layui-input-block">
                                    <input type="text" name="key" value="$!data.key" id="key" readonly
                                           class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label"><span class="x-red">*</span>监听端口</label>
                            <div class="layui-input-block">
                                <input type="text" name="port" value="$!data.port" class="layui-input"
                                       id="port" required lay-verify="required"
                                       placeholder="设置listen监听端口">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label"><span class="x-red">*</span>域名</label>
                            <div class="layui-input-block">
                                <input type="text" name="domain" value="$!data.domain" id="domain" required
                                       lay-verify="required" placeholder="设置server_name匹配域名"
                                       class="layui-input">
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                <span class="x-red">*</span>代理地址
                            </label>
                            <div class="layui-input-block">
                                <input type="text" name="location" value="$!data.location" required
                                       lay-verify="required" placeholder="设置proxy_pass代理跳转地址"
                                       class="layui-input">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            #if($user.isSystemUser())
                <button type="button" class="layui-btn" id="manual">手动配置</button>
            #end
            <button class="layui-btn" lay-submit lay-filter="submitFast">提交</button>
        </div>
    </div>
</form>

    #if($user.isSystemUser())
    <div hidden id="manualConfig">
        <form action="" class="layui-form" id="form_ngx" style="padding: 10px 15px 0px 0px;">
            <input type="hidden" name="type" value="manual">
            <input type="hidden" name="genre" value="$type">
            <div class="layui-form-item">
                <label class="layui-form-label">文件路径</label>
                <div class="layui-input-inline">
                    <select name="whitePath" id="whitePath" required lay-verify="required"
                            #if($type=="update")disabled #end>
                        <option value="">请选择白名单路径</option>
                        #foreach($item in $nginx)
                            <option value="$item" #if($item==$data.whitePath) selected #end>$!item</option>
                        #end
                    </select>
                </div>
                <label class="layui-form-label">文件名称</label>
                <div class="layui-input-inline">
                    <input type="text" name="name" placeholder='文件后缀必须为".conf"' class="layui-input"  #if($type==
                        "update") disabled #end value="$!data.name" required lay-verify="required">
                </div>

            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">配置内容</label>
                <div class="layui-input-block auto">
                        <textarea name="context" required lay-verify="required" placeholder="请填写nginx配置内容"
                                  class="layui-textarea context">$!data.context</textarea>
                </div>
            </div>
            <input type="hidden" class="layui-btn" lay-submit lay-filter="submitNgx" id="ngx_submit">
        </form>
    </div>
    #end

<script type="text/javascript">

    function loadSuccess() {
        var type = "$type"
        if ("add" === type) {
            $("#port ").val("80");
        }

        //提交配置信息
        form.on('submit(submitNgx)', function (data) {
            loadingAjax({
                url: './updateNgx',
                data: data.field,
                success: function (data) {
                    layer.msg(data.msg);
                    if (200 == data.code) {
                        if ("update" === type) {
                            layer.closeAll('page');
                            window.location.reload()
                        } else {
                            closeTab();
                        }
                    }
                }
            });
            return false;
        });

        //提交配置信息
        form.on('submit(submitFast)', function (data) {
            loadingAjax({
                url: './updateNgx',
                data: data.field,
                success: function (data) {
                    layer.msg(data.msg);
                    if (200 == data.code) {
                        if ("update" === type) {
                            layer.closeAll('page');
                            window.location.reload()
                        } else {
                            closeTab();
                        }
                    }
                }
            });
            return false;
        });

        //缓存开关设置
        form.on('switch(cacheStatus)', function (data) {
            var dom = $("#cache_setting");
            if (data.elem.checked) {
                dom.removeClass("div_hidden");
            } else {
                dom.addClass("div_hidden");
            }
        });
        #if($user.isSystemUser())
            $("#manual").on("click", function () {
                document.getElementById('form_ngx').reset();
                layer.open({
                    type: 1,
                    title: '手动配置',
                    content: $('#manualConfig'),
                    area: ['60%', '90%'],
                    btnAlign: 'c',
                    btn: ['提交'],
                    yes: function (index, layero) {
                        $('#ngx_submit').click();
                    }
                });
            });
        #end

        //选择证书
        form.on('select(choose_cert)', function (data) {
            if (!data.value || data.value == "") {
                $("#convert").hide();
                $("#cert").val("");
                $("#key").val("");
                $("#keyAux").val("");
                $("#certAux").val("");
                $("#port ").val("80");
                return false;
            }
            $("#convert").show();
            var cert = $("#choose_cert").find('[value="' + data.value + '"]').attr("cert");
            var key = $("#choose_cert").find('[value="' + data.value + '"]').attr("key");
            var domain = $("#choose_cert").find('[value="' + data.value + '"]').attr("id");
            $("#cert").val(cert);
            $("#domain").val(domain);
            $("#key").val(key);
            $("#keyAux").val(key);
            $("#certAux").val(cert);
            $("#port ").val("443 ssl");
        });
    }

    function closeTab() {
        try {
            top.frames["nginx"].location.reload();
        } catch (e) {
            console.error(e);
        }
        var element = top.layui.element;
        element.tabDelete('mainTabs', "tab_nginx_add新增配置");
    }

</script>

</html>