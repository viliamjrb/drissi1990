<!DOCTYPE html>
<html>

<head>
    #parse("./common/head.vm")
    <title>项目管理系统</title>
    <link rel="stylesheet" href="/static/css/manage/projectInfo.css" media="all">
</head>

<body>
<div class="layui-row">
    <button id="addProject" class="layui-btn layui-btn-sm">新增项目</button>
    <button id="refresh" class="layui-btn layui-btn-sm">刷新表格</button>
    <button id="updateRunBoot" class="layui-btn layui-btn-sm">修改启动文件</button>
</div>
<table class="layui-table" id="tab_project" lay-filter="tab_project" style="margin: 0;"></table>

<div class="div-runboot" id="div-runboot">
    <form action="" class="layui-form" id="form_runboot">
        <textarea id="ta_runboot" name="content"></textarea>
        <input type="hidden" lay-submit lay-filter="submitRunBoot" id="runboot_submit">
    </form>
</div>
</body>

<script type="text/html" id="bar_projects">
    <a href="javascript:;" class="layui-btn  layui-btn-sm layui-btn-normal" lay-event="manage">控制台</a>
    <a href="javascript:;" class="layui-btn  layui-btn-sm layui-btn-warm" lay-event="update">配置</a>
    <a href="javascript:;" class="layui-btn  layui-btn-sm layui-btn" lay-event="file">文件</a>
    <a href="javascript:;" class="layui-btn  layui-btn-sm layui-btn" lay-event="build">构建</a>
    <a href="javascript:;" class="layui-btn  layui-btn-sm layui-btn" lay-event="ram">内存</a>
</script>
<script type="text/html" id="status_templ">
    <input type="checkbox" disabled name="status" {{# if(d.status){ }} checked {{# } }} lay-skin="switch"
           lay-text="运行中|未运行">
</script>

<script type="text/javascript">
    var table;
    layui.use(['layer', 'element', 'table', 'form'], function () {
        var $ = layui.$;
        table = layui.table;
        var form = layui.form;
        var layer = layui.layer;

        table.render({
            id: 'table_project',
            elem: '#tab_project',
            url: '/manage/getProjectInfo',
            height: 'full-52',
            even: true,
            cols: [[
                {field: 'id', title: '项目名称', width: '15%'},
                {
                    title: 'lib状态', width: '10%', templet: function (d) {
                        return (d.runLibDesc || "") + " / " + (d.useLibDesc || "");
                    }
                },
                {field: 'createTime', title: '创建时间', width: '13%'},
                {field: 'modifyTime', title: '修改时间', width: '13%'},
                {title: '运行状态', templet: "#status_templ", width: '10%'},
                {field: 'op', title: '操作', toolbar: '#bar_projects'}
            ]],
            loading: true,
            response: {
                statusCode: 200
            }
        });

        // '刷新表格'点击事件
        $('#refresh').on('click', function () {
            reloadTable();
        });

        // '修改启动文件'点击事件
        $('#updateRunBoot').on('click', function () {
            $.ajax({
                url: '/file/getRunBoot',
                type: 'get',
                dataType: 'json',
                success: function (data) {
                    if (200 == data.code) {
                        $('#ta_runboot').val(data.data.content);
                        layer.open({
                            type: 1,
                            title: '修改启动文件',
                            content: $('#div-runboot'),
                            area: ['80%', '80%'],
                            btnAlign: 'c',
                            btn: ['提交'],
                            yes: function (index, layero) {
                                $('#form_runboot').attr('action', '/file/saveRunBoot');
                                $('#runboot_submit').click();
                            }
                        });
                    } else {
                        layer.msg('启动文件不存在');
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            });
        });

        // 提交启动文件表单
        form.on('submit(submitRunBoot)', function (data) {
            $.ajax({
                url: data.form.action,
                type: 'POST',
                dataType: 'json',
                data: data.field,
                success: function (data) {
                    if (200 == data.code) {
                        layer.closeAll('page');

                        layer.msg('修改成功！');
                    } else {
                        layer.msg('修改失败！');
                    }
                },
                error: function (err) {
                    layer.msg('操作失败！');
                }
            });
            return false;
        }); // '添加项目'点击事件
        $('#addProject').on('click', function () {
            editProject("");
        });

        function editProject(id) {
            layer.open({
                type: 2,
                title: '管理项目配置信息',
                shade: 0.8,
                area: ['80%', '90%'],
                content: 'editProject?id=' + id
            });
        }

        // 表格工具条事件
        table.on('tool(tab_project)', function (obj) {
            var data = obj.data;
            var event = obj.event;
            if ('update' === event) {
                editProject(data.id);
            } else if ('manage' === event) {
                // 管理
                manageApplication(data);
            } else if ('file' === event) {
                fileManage(data);
            } else if ('build' === event) {
                layer.open({
                    type: 2,
                    title: '自动构建',
                    shade: 0.8,
                    area: ['80%', '90%'],
                    content: 'build?id=' + data.id
                });
            } else if ('ram' === event) {
                layer.open({
                    type: 2,
                    title: '内存',
                    shade: 0.8,
                    area: ['60%', '50%'],
                    content: 'internal?id=' + data.id
                });
            }
        });

        // 文件管理
        function fileManage(data) {
            var lay_id = 'tab_file_' + data.id;
            var url = '/file/filemanage?id=' + data.id;
            tabChange({
                id: data.id,
                url: url,
                title: data.id + ' - 文件',
            });
        }

        // 管理
        function manageApplication(data) {
            var url = '/manage/console?id=' + data.id;
            tabChange({
                id: data.id,
                url: url,
                title: data.id + ' - 管理',
            });
        }
    });

    function reloadTable() {
        table.reload('table_project', {height: 'full-52'});
    }
</script>
</html>